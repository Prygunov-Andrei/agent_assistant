#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –±–æ—Ç–∞ —Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä

REMOTE_SERVER="root@217.151.231.96"
SSH_KEY="~/.ssh/id_rsa_server"

echo "üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ Telegram –±–æ—Ç–∞ –Ω–∞ –£–î–ê–õ–ï–ù–ù–´–ô —Ä–µ–∂–∏–º"
echo "================================================"
echo ""

# 1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞
echo "üíª –®–∞–≥ 1/3: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞..."

if docker ps | grep -q "agent_assistant_telegram_bot_local"; then
    echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞..."
    cd "$(dirname "$0")/../.." || exit 1
    docker-compose -f docker/docker-compose.bot.local.yml --env-file .env down
    echo "‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–π –±–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
else
    echo "‚ÑπÔ∏è  –õ–æ–∫–∞–ª—å–Ω—ã–π –±–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω"
fi

echo ""

# –ñ–¥–µ–º –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ Telegram
echo "‚è≥ –®–∞–≥ 2/3: –û–∂–∏–¥–∞–Ω–∏–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ Telegram (15 —Å–µ–∫)..."
sleep 15
echo "‚úÖ –¢–æ–∫–µ–Ω —Å–≤–æ–±–æ–¥–µ–Ω"
echo ""

# 3. –ó–∞–ø—É—Å–∫ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –±–æ—Ç–∞
echo "üì° –®–∞–≥ 3/3: –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ..."

ssh -i $SSH_KEY $REMOTE_SERVER "cd /opt/agent_assistant && docker-compose -f docker/docker-compose.prod.yml up -d --build telegram-bot"

if [ $? -eq 0 ]; then
    sleep 3
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
    REMOTE_STATUS=$(ssh -i $SSH_KEY $REMOTE_SERVER "docker ps | grep telegram-bot")
    
    if [ ! -z "$REMOTE_STATUS" ]; then
        echo ""
        echo "‚úÖ‚úÖ‚úÖ –£–°–ü–ï–®–ù–û! ‚úÖ‚úÖ‚úÖ"
        echo "================================================"
        echo "üì° –£–¥–∞–ª–µ–Ω–Ω—ã–π Telegram –±–æ—Ç –∑–∞–ø—É—â–µ–Ω!"
        echo "üíª –õ–æ–∫–∞–ª—å–Ω—ã–π –±–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        echo ""
        echo "–ë–æ—Ç —Ç–µ–ø–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ —É–¥–∞–ª–µ–Ω–Ω–æ–º—É backend:"
        echo "  http://217.151.231.96/api"
        echo ""
        echo "üìã –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –±–æ—Ç–∞:"
        echo "  ssh -i ~/.ssh/id_rsa_server root@217.151.231.96"
        echo "  cd /opt/agent_assistant"
        echo "  docker-compose -f docker/docker-compose.prod.yml logs -f telegram-bot"
        echo ""
        echo "üîÑ –î–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π:"
        echo "  ./bot_switch_to_local.sh"
        echo "================================================"
    else
        echo ""
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –±–æ—Ç–∞!"
        echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
        exit 1
    fi
else
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –±–æ—Ç–∞!"
    echo ""
    echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –õ–æ–∫–∞–ª—å–Ω—ã–π –±–æ—Ç –±—ã–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    echo "–î–ª—è –∑–∞–ø—É—Å–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞: ./bot_switch_to_local.sh"
    exit 1
fi
