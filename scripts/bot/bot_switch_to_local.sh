#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –±–æ—Ç–∞ —Å —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π

REMOTE_SERVER="root@217.151.231.96"
SSH_KEY="~/.ssh/id_rsa_server"

echo "üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ Telegram –±–æ—Ç–∞ –Ω–∞ –õ–û–ö–ê–õ–¨–ù–´–ô —Ä–µ–∂–∏–º"
echo "================================================"
echo ""

# 1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –±–æ—Ç–∞
echo "üì° –®–∞–≥ 1/4: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ..."

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–æ—Ç–∞ –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
ssh -i $SSH_KEY $REMOTE_SERVER "cd /opt/agent_assistant && docker-compose -f docker/docker-compose.prod.yml stop telegram-bot 2>/dev/null && docker-compose -f docker/docker-compose.prod.yml rm -f telegram-bot 2>/dev/null || docker stop \$(docker ps -q --filter name=telegram) 2>/dev/null || true"

if [ $? -eq 0 ]; then
    echo "‚úÖ –£–¥–∞–ª–µ–Ω–Ω—ã–π –±–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
else
    echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –±–æ—Ç–∞ (–≤–æ–∑–º–æ–∂–Ω–æ —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)"
fi

echo ""

# –ñ–¥–µ–º –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ Telegram
echo "‚è≥ –®–∞–≥ 2/4: –û–∂–∏–¥–∞–Ω–∏–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ Telegram (15 —Å–µ–∫)..."
sleep 15
echo "‚úÖ –¢–æ–∫–µ–Ω —Å–≤–æ–±–æ–¥–µ–Ω"
echo ""

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "üîç –®–∞–≥ 3/4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."

if [ ! -f .env ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

if ! grep -q "BOT_TOKEN=" .env; then
    echo "‚ùå –û—à–∏–±–∫–∞: BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ!"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ª–æ–∫–∞–ª—å–Ω—ã–π backend –∑–∞–ø—É—â–µ–Ω
if ! curl -s http://localhost:8000/api/ > /dev/null 2>&1; then
    echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –õ–æ–∫–∞–ª—å–Ω—ã–π backend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ http://localhost:8000/api/"
    echo ""
    echo "–î–ª—è –∑–∞–ø—É—Å–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ backend –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
    echo "  docker-compose up -d backend db"
    echo ""
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "‚ùå –û—Ç–º–µ–Ω–∞ –∑–∞–ø—É—Å–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞"
        echo ""
        echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –£–¥–∞–ª–µ–Ω–Ω—ã–π –±–æ—Ç –±—ã–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
        echo "–î–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: ./bot_switch_to_remote.sh"
        exit 1
    fi
fi

echo "‚úÖ –õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ"
echo ""

# 4. –ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞
echo "üöÄ –®–∞–≥ 4/4: –ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞..."

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
if docker ps -a | grep -q "agent_assistant_telegram_bot_local"; then
    echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–æ—Ç–∞..."
    docker stop agent_assistant_telegram_bot_local 2>/dev/null || true
    docker rm agent_assistant_telegram_bot_local 2>/dev/null || true
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞
echo "–ó–∞–ø—É—Å–∫–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞..."
cd "$(dirname "$0")/../.." || exit 1
docker-compose -f docker/docker-compose.bot.local.yml --env-file .env up -d --build

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
if docker ps | grep -q "agent_assistant_telegram_bot_local"; then
    echo ""
    echo "‚úÖ‚úÖ‚úÖ –£–°–ü–ï–®–ù–û! ‚úÖ‚úÖ‚úÖ"
    echo "================================================"
    echo "ü§ñ –õ–æ–∫–∞–ª—å–Ω—ã–π Telegram –±–æ—Ç –∑–∞–ø—É—â–µ–Ω!"
    echo "üì° –£–¥–∞–ª–µ–Ω–Ω—ã–π –±–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    echo ""
    echo "–ë–æ—Ç —Ç–µ–ø–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É backend:"
    echo "  http://localhost:8000/api"
    echo ""
    echo "üìã –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
    echo "  –õ–æ–≥–∏ –±–æ—Ç–∞:           docker logs -f agent_assistant_telegram_bot_local"
    echo "  –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞:     docker-compose -f docker/docker-compose.bot.local.yml --env-file .env down"
    echo "  –í–µ—Ä–Ω—É—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä:   ./scripts/bot/bot_switch_to_remote.sh"
    echo ""
    echo "üí° –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
    echo "   docker logs -f agent_assistant_telegram_bot_local"
    echo "================================================"
else
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞!"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: docker logs agent_assistant_telegram_bot_local"
    echo ""
    echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –£–¥–∞–ª–µ–Ω–Ω—ã–π –±–æ—Ç –±—ã–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    echo "–î–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: ./bot_switch_to_remote.sh"
    exit 1
fi
