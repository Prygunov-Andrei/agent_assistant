#!/usr/bin/expect -f

set timeout 300
set server "217.151.231.96"
set password "j7EF^1u+V?Zpz9"

# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
spawn ssh -o StrictHostKeyChecking=no root@$server

# –û–∂–∏–¥–∞–µ–º –∑–∞–ø—Ä–æ—Å –ø–∞—Ä–æ–ª—è
expect {
    "password:" {
        send "$password\r"
    }
    timeout {
        puts "Timeout waiting for password prompt"
        exit 1
    }
}

# –û–∂–∏–¥–∞–µ–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
expect {
    "#" {
        puts "\n‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É\n"
    }
    timeout {
        puts "Timeout waiting for shell prompt"
        exit 1
    }
}

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
send "cd /opt/agent_assistant\r"
expect "#"

puts "\nüìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã...\n"
send "ls -la | head -20\r"
expect "#"

puts "\nüîç –ü—Ä–æ–≤–µ—Ä–∫–∞ .env —Ñ–∞–π–ª–∞...\n"
send "grep SECRET_KEY .env\r"
expect "#"

puts "\n‚ö†Ô∏è –ï—Å–ª–∏ SECRET_KEY —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã - –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å!\n"
puts "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (yes –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è, no –¥–ª—è –≤—ã—Ö–æ–¥–∞)\r"

# –ñ–¥—ë–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
interact {
    "yes\r" {
        send "cd /opt/agent_assistant\r"
        expect "#"
        
        puts "\nüõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã...\n"
        send "docker stop \$(docker ps -q --filter \"name=agent_assistant\") 2>/dev/null; docker rm \$(docker ps -aq --filter \"name=agent_assistant\") 2>/dev/null\r"
        expect "#"
        
        puts "\nüöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç...\n"
        send "docker-compose -f docker/docker-compose.prod.yml --env-file .env up -d --build\r"
        expect "#"
        
        puts "\n‚úÖ –ì–æ—Ç–æ–≤–æ! –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å...\n"
        send "docker ps --filter \"name=agent_assistant\"\r"
        expect "#"
        
        puts "\n\n–°–µ—Ä–≤–µ—Ä –æ–±–Ω–æ–≤–ª—ë–Ω!\n"
    }
    "no\r" {
        puts "\n–û—Ç–º–µ–Ω–µ–Ω–æ. –í—ã—Ö–æ–¥...\n"
        send "exit\r"
    }
}

