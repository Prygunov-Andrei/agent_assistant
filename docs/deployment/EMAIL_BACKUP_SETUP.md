# Подробная настройка Email для системы резервного копирования

Для работы системы резервного копирования базы данных с отправкой по email необходимо настроить SMTP сервер и параметры email.

## 1. Настройка SMTP сервера

### 1.1 Выбор SMTP провайдера

**Рекомендуемые провайдеры:**
- **Gmail** - надежный, бесплатный, 15GB
- **Yandex** - хорошая поддержка русского языка
- **Mail.ru** - популярный в России
- **Outlook/Hotmail** - корпоративный стандарт

### 1.2 Настройка Gmail

#### Создание App Password
1. Войдите в [Gmail](https://gmail.com)
2. Перейдите в **Настройки аккаунта** → **Безопасность**
3. Включите **Двухфакторную аутентификацию** (если не включена)
4. Найдите **Пароли приложений** и создайте новый
5. Выберите **Почта** и **Другое устройство**
6. Введите название: `AgentAssistant-Backup`
7. **Скопируйте сгенерированный пароль** (16 символов)

#### Настройки для .env
```bash
# SMTP Configuration for Gmail
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=your-16-character-app-password
DEFAULT_FROM_EMAIL=your-email@gmail.com
```

### 1.3 Настройка Yandex

#### Включение SMTP
1. Войдите в [Яндекс.Почта](https://mail.yandex.ru)
2. Перейдите в **Настройки** → **Почтовые программы**
3. Включите **IMAP** и **SMTP**
4. Создайте **Пароль для приложений**

#### Настройки для .env
```bash
# SMTP Configuration for Yandex
EMAIL_HOST=smtp.yandex.ru
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=your-email@yandex.ru
EMAIL_HOST_PASSWORD=your-app-password
DEFAULT_FROM_EMAIL=your-email@yandex.ru
```

### 1.4 Настройка Mail.ru

#### Включение SMTP
1. Войдите в [Mail.ru](https://mail.ru)
2. Перейдите в **Настройки** → **Почтовые программы**
3. Включите **SMTP**
4. Создайте **Пароль для внешних приложений**

#### Настройки для .env
```bash
# SMTP Configuration for Mail.ru
EMAIL_HOST=smtp.mail.ru
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=your-email@mail.ru
EMAIL_HOST_PASSWORD=your-app-password
DEFAULT_FROM_EMAIL=your-email@mail.ru
```

## 2. Настройка системы резервного копирования

### 2.1 Основные настройки
Добавьте в ваш `.env` файл:

```bash
# ==============================
# EMAIL BACKUP SETTINGS
# ==============================

# Email Configuration for Backup
EMAIL_BACKUP_ENABLED=True
EMAIL_BACKUP_RECIPIENT=your-email@example.com
EMAIL_BACKUP_SUBJECT_PREFIX=[AgentAssistant] Backup

# Local Backup Settings
LOCAL_BACKUP_DIR=/app/backups
LOCAL_BACKUP_FILENAME=latest_backup.sql.gz

# Database backup timeout (seconds)
DB_BACKUP_TIMEOUT=300
```

### 2.2 Описание параметров

**EMAIL_BACKUP_ENABLED**
- `True` - включить отправку бэкапов по email
- `False` - отключить отправку (только локальное хранение)

**EMAIL_BACKUP_RECIPIENT**
- Email адрес получателя бэкапов
- Может быть тот же, что и EMAIL_HOST_USER

**EMAIL_BACKUP_SUBJECT_PREFIX**
- Префикс для темы письма
- По умолчанию: `[AgentAssistant] Backup`

**LOCAL_BACKUP_DIR**
- Папка для хранения бэкапов на сервере
- По умолчанию: `/app/backups`

**LOCAL_BACKUP_FILENAME**
- Имя файла последнего бэкапа
- По умолчанию: `latest_backup.sql.gz`

**DB_BACKUP_TIMEOUT**
- Таймаут создания дампа БД в секундах
- По умолчанию: 300 (5 минут)

## 3. Проверка настройки

### 3.1 Перезапуск контейнеров
После обновления `.env` файла перезапустите контейнеры:

```bash
# Остановка всех сервисов
./scripts/deploy/stop_all.sh

# Запуск всех сервисов
./scripts/deploy/start_all.sh
```

### 3.2 Тестирование через веб-интерфейс
1. Откройте веб-интерфейс приложения
2. Войдите в систему как администратор
3. Перейдите в **"Настройки" → "Резервные копии"**
4. Нажмите кнопку **"Создать новый бэкап"**
5. Дождитесь завершения процесса (может занять несколько минут)
6. Проверьте почту - должен прийти файл бэкапа

### 3.3 Проверка локального хранения
1. Подключитесь к серверу
2. Проверьте папку `/app/backups` (или указанную в `LOCAL_BACKUP_DIR`)
3. Убедитесь, что там есть файл `latest_backup.sql.gz`

## 4. Автоматические функции системы

### 4.1 Локальное хранение
- **Папка**: Создается автоматически при первом бэкапе
- **Файл**: Всегда один файл `latest_backup.sql.gz`
- **Перезапись**: Старый бэкап автоматически заменяется новым

### 4.2 Email отправка
- **Тема**: `[AgentAssistant] Backup - YYYY-MM-DD HH:MM`
- **Содержимое**: Информация о бэкапе + прикрепленный файл
- **Формат файла**: `.sql.gz` (сжатый дамп PostgreSQL)

### 4.3 Логирование
- Все операции логируются в Django logs
- Ошибки записываются для диагностики
- Статус отправки email отображается в интерфейсе

## 5. Устранение неполадок

### 5.1 Ошибка "SMTP Authentication failed"
**Причина:** Неправильные учетные данные SMTP

**Решение:**
1. Проверьте правильность email и пароля
2. Для Gmail используйте App Password вместо обычного пароля
3. Убедитесь, что включена двухфакторная аутентификация
4. Проверьте, что пароль не содержит пробелов

### 5.2 Ошибка "Connection refused"
**Причина:** Проблемы с подключением к SMTP серверу

**Решение:**
1. Проверьте правильность SMTP сервера и порта
2. Убедитесь, что сервер доступен из контейнера
3. Проверьте настройки файрвола
4. Попробуйте другой порт (465 для SSL)

### 5.3 Ошибка "Email not sent"
**Причина:** Проблемы с настройками email

**Решение:**
1. Проверьте настройки `EMAIL_BACKUP_ENABLED=True`
2. Убедитесь, что указан `EMAIL_BACKUP_RECIPIENT`
3. Проверьте логи Django на наличие ошибок
4. Убедитесь, что SMTP сервер работает

### 5.4 Ошибка "Database backup failed"
**Причина:** Проблемы с созданием дампа базы данных

**Решение:**
1. Проверьте подключение к базе данных PostgreSQL
2. Убедитесь, что у пользователя БД есть права на создание дампов
3. Проверьте свободное место на диске
4. Увеличьте `DB_BACKUP_TIMEOUT` для больших БД

### 5.5 Ошибка "Permission denied"
**Причина:** Недостаточно прав для создания папки

**Решение:**
1. Проверьте права доступа к папке `/app/backups`
2. Убедитесь, что контейнер может создавать папки
3. Проверьте настройки Docker volumes

## 6. Безопасность и рекомендации

### 6.1 Безопасность паролей
- Используйте App Passwords вместо основных паролей
- Храните пароли в переменных окружения, а не в коде
- Регулярно обновляйте пароли приложений
- Не коммитьте пароли в Git репозиторий

### 6.2 Мониторинг
- Регулярно проверяйте логи на наличие ошибок
- Следите за размером бэкапов
- Проверяйте, что email доставляются
- Мониторьте свободное место на диске

### 6.3 Резервное копирование настроек
- Сохраните настройки SMTP в безопасном месте
- Документируйте процесс получения App Passwords
- Имейте план восстановления на случай потери настроек

## 7. Дополнительные настройки

### 7.1 Изменение получателя email
Чтобы изменить получателя бэкапов:
```bash
EMAIL_BACKUP_RECIPIENT=new-email@example.com
```

### 7.2 Отключение email уведомлений
Чтобы отключить отправку email:
```bash
EMAIL_BACKUP_ENABLED=False
```

### 7.3 Изменение папки хранения
Чтобы изменить папку для бэкапов:
```bash
LOCAL_BACKUP_DIR=/custom/backup/path
```

### 7.4 Настройка таймаута
Для больших баз данных может потребоваться увеличить таймаут:
```bash
DB_BACKUP_TIMEOUT=600  # 10 минут вместо 5
```

## 8. Интеграция с другими системами

### 8.1 Webhook уведомления
Можно добавить webhook для уведомления других систем о создании бэкапа.

### 8.2 Интеграция с мониторингом
Можно интегрировать с системами мониторинга для отслеживания статуса бэкапов.

### 8.3 Автоматическое тестирование
Можно добавить автоматические тесты для проверки работоспособности системы бэкапов.

После выполнения всех этих шагов система резервного копирования будет готова к работе с локальным хранением и отправкой по email.
