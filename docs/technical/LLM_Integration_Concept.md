# Концепция интеграции LLM для автоматического анализа запросов

## 1. Описание концепции

### 1.1 Основная идея
При нажатии на запрос в таблице происходит автоматический анализ через языковую модель (LLM), которая:
1. Получает JSON со всеми артистами из базы данных
2. Получает JSON с текстовыми данными запроса (без медиафайлов)
3. Анализирует запрос и подбирает подходящих артистов
4. Возвращает структурированный JSON с предзаполненной формой проекта

### 1.2 Workflow
```
Запрос → [JSON: Артисты + Запрос] → LLM → [JSON: Структурированный ответ + Контакты] → Поиск совпадений в БД → Форма проекта (предзаполненная + предложения) → Корректировка агентом → Сохранение

Альтернативно:
Ручное создание → Форма проекта (пустая) → Заполнение → Сохранение
```

**Важно:** Результат анализа LLM НЕ хранится в базе данных. JSON от LLM сразу передается в форму проекта для предзаполнения полей. Агент проверяет и корректирует все данные перед сохранением.

### 1.3 Особенности интерфейса
- **Роли в вкладках**: Каждая роль в отдельном блоке-закладке (обычно 1, иногда 2-3, максимум 5)
- **Кнопки управления**: "Добавить роль" и "Удалить роль" для каждой роли
- **Фиксированный контекст**: Текст запроса и медиафайлы постоянно видны сверху (25% экрана)
- **Медиафайлы**: Изображения отображаются в масштабе, не занимая много места. Документы показываются по названиям файлов с возможностью скачивания при нажатии
- **Статус LLM**: Индикатор в центре экрана с анимацией загрузки

### 1.4 Механизм подстановки совпадений

#### Интерфейс предложений
```
┌─────────────────────────────────────────────────────────┐
│ Кастинг-директор: Иван Петров                          │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ Найдены совпадения в базе данных:                  │ │
│ │ ○ Иван Петров (ivan.petrov@example.com) - 95%     │ │
│ │ ○ Иван Петровский (i.petrovsky@test.ru) - 78%     │ │
│ │ ○ Петр Иванов (p.ivanov@casting.com) - 65%        │ │
│ │ + Создать нового кастинг-директора                 │ │
│ └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

#### Алгоритм поиска совпадений
- **Точное совпадение** (100%) - идентичные данные
- **Высокое совпадение** (80-99%) - похожие имена + совпадающие контакты
- **Среднее совпадение** (60-79%) - похожие имена или совпадающие контакты
- **Низкое совпадение** (40-59%) - частичное совпадение данных

#### Приоритеты поиска
1. **Email** - самый надежный идентификатор
2. **Телефон** - высокий приоритет
3. **Telegram** - средний приоритет
4. **Имя + Фамилия** - низкий приоритет, но с проверкой схожести

## 2. Необходимые доработки в текущем проекте

### 2.1 Модели данных

#### Обновление существующих моделей

**Модель Request:**
- [x] Поле `status` уже существует с нужными значениями
- [ ] Добавить поле `project` - связь с Project (один запрос → один проект, null=True, если проект не создан - можно удалить запрос)
- [ ] Добавить поле `analysis_status` - статус анализа LLM ('new', 'analyzed', 'processed')

**Модель Project:**
- [ ] Добавить поле `request` - обратная связь с Request (один проект ← один запрос)
- [ ] Добавить поле `project_type_raw` - сырой тип проекта от LLM (строка, для отображения)

**Модель ProjectRole:**
- [ ] Добавить поле `suggested_artists` - ManyToManyField к Artist (предложенные LLM артисты)
- [ ] Добавить поле `skills_required` - JSONField для требуемых навыков (простое решение)
- [ ] Использовать существующее поле `description` для возраста, пола и других характеристик роли (например: "мужчина 25-35 лет, рост 175-185 см")

#### Новые модели (НЕ НУЖНЫ)

**❌ ProjectAnalysis - НЕ СОЗДАЕМ**
- Результаты анализа LLM не храним в БД
- LLM JSON → сразу в форму → корректировка → сохранение
- Для датасета используем только финальные исправленные данные (что агент сохранил)

**❌ TrainingDataset - НЕ СОЗДАЕМ** 
- Обучающий датасет формируется динамически из исправленных проектов
- Экспорт через Django management команду или кнопку в админ-панели
- Используем только данные, которые агент исправил и сохранил
- Каждый файл содержит 50 записей (последний файл может содержать меньше)

### 2.2 API Endpoints

#### Основные endpoints
- [ ] `POST /api/requests/{id}/analyze/` - запуск анализа через LLM (возвращает JSON для формы)
- [ ] `POST /api/projects/` - создание проекта (универсальный endpoint)
- [ ] `GET /api/projects/` - список проектов агента
- [ ] `PUT /api/projects/{id}/` - редактирование проекта

#### Endpoints для поиска совпадений
- [ ] `POST /api/persons/search-matches/` - поиск совпадений персон (кастинг-директоры, режиссеры, продюсеры)
- [ ] `POST /api/companies/search-matches/` - поиск совпадений кинокомпаний
- [ ] `POST /api/projects/search-matches/` - поиск совпадений проектов по названию

#### Endpoints для управления запросами
- [ ] `DELETE /api/requests/{id}/` - удаление запроса (если не создан проект, например спам)
- [ ] `GET /api/requests/{id}/can-delete/` - проверка возможности удаления запроса

### 2.3 Сервисы

#### Основные сервисы
- [ ] `LLMAnalysisService` - интеграция с внешним LLM API
- [ ] `ProjectFormService` - универсальная генерация форм (пустых и предзаполненных)
- [ ] `ProjectCreationService` - единая логика создания проектов

#### Сервисы поиска совпадений
- [ ] `PersonMatchingService` - поиск совпадений персон в БД (используем существующие поля: email, phone, telegram_username)
- [ ] `CompanyMatchingService` - поиск совпадений кинокомпаний в БД
- [ ] `ProjectMatchingService` - поиск совпадений проектов в БД (fuzzy matching по названию)

#### Сервисы для датасета
- [ ] `TrainingDatasetService` - формирование обучающего датасета из исправленных проектов (только финальные данные, которые агент сохранил)
- [ ] `DatasetExportService` - экспорт датасета в JSONL файлы по 50 записей в каждом
- [ ] `OpenAIFineTuningService` - интеграция с OpenAI для дообучения (опционально, для будущего развития)

### 2.4 Frontend компоненты

#### Основные формы
- [ ] `ProjectCreationForm` - универсальная форма создания/редактирования проекта
- [ ] `ProjectRoleForm` - компонент для создания/редактирования ролей
- [ ] `ArtistSelectionComponent` - компонент выбора артистов для ролей
- [ ] `ProjectList` - список проектов агента

#### Компоненты выбора с поиском совпадений
- [ ] `PersonSelectionComponent` - компонент выбора персон с поиском совпадений
- [ ] `CompanySelectionComponent` - компонент выбора компаний с поиском совпадений
- [ ] `ProjectSelectionComponent` - компонент выбора проектов с поиском совпадений
- [ ] `MatchingSuggestions` - предложения совпадений из БД
- [ ] `DuplicateProjectWarning` - предупреждение о дубликатах проектов

#### UI компоненты
- [ ] `FixedContextPanel` - фиксированная панель с текстом запроса и медиафайлами (25% экрана)
- [ ] `MediaViewer` - просмотрщик медиафайлов (изображения в масштабе, документы по названиям)
- [ ] `ImageGallery` - галерея изображений с компактным отображением
- [ ] `DocumentList` - список документов с названиями файлов и скачиванием при нажатии
- [ ] `LLMStatusIndicator` - индикатор статуса работы LLM (центр экрана)
- [ ] `ValidationErrorDisplay` - отображение ошибок валидации LLM (блоки)
- [ ] `NotificationBanner` - баннеры уведомлений (красный/желтый)

### 2.5 Конфигурация
- [ ] Настройки LLM API (ключи, эндпоинты, модели)
- [ ] Промпты для различных типов запросов (YAML конфигурационные файлы)
- [ ] Лимиты и ограничения на использование LLM
- [ ] Конфигурация системы поиска совпадений (пороги схожести для каждой сущности, количество результатов) - отдельный файл настроек
- [ ] Настройки валидации LLM (количество повторных попыток)
- [ ] Настройки экспорта датасетов (размер файлов, формат)

### 2.6 Пример конфигурационного файла (YAML)
```yaml
# llm_config.yaml
llm:
  model: "gpt-4o"
  temperature: 0.3
  max_tokens: 2000
  max_retries: 1

search_thresholds:
  persons:
    casting_directors: 0.7
    directors: 0.6
    producers: 0.6
  companies: 0.8
  projects: 0.6

search_limits:
  max_results: 5
  min_confidence: 0.4

dataset_export:
  records_per_file: 50
  file_format: "jsonl"

prompts:
  system: "Ты агент в большом агентстве артистов..."
  user_template: "Проанализируй следующий запрос..."
```

## 3. Детальные JSON структуры

### 3.1 Входные данные для LLM (Request + Artists)
```json
{
  "request": {
    "id": 123,
    "text": "Ищем актера на роль детектива в детективной драме...",
    "author_name": "Иван Петров",
    "created_at": "2024-01-15T10:30:00Z"
  },
  "artists": [
    {
      "id": 1,
      "name": "Алексей Иванов",
      "age": 30,
      "gender": "male",
      "skills": ["Актерское мастерство", "Карате"],
      "experience": "5 лет",
      "physical": {
        "height": "180 см",
        "body_type": "атлетическое"
      }
    }
  ]
}
```

### 3.2 Выходные данные от LLM (Project Analysis)
```json
{
  "project_analysis": {
    "project_title": "Детективная драма",
    "project_type": "фильм",
    "description": "Детективная драма о расследовании серии убийств...",
    "genre": "драма",
    "roles": [
      {
        "name": "Детектив Петров",
        "description": "мужчина 30-40 лет, опытный следователь",
        "suggested_artists": [1, 5, 12],
        "skills_required": ["Актерское мастерство", "Драма"]
      }
    ],
    "casting_director": {
      "name": "Иван Петров",
      "email": "ivan.petrov@example.com",
      "phone": "+7-999-123-45-67",
      "telegram": "@ivan_petrov",
      "confidence": 0.9
    },
    "director": {
      "name": "Не определен",
      "email": "",
      "phone": "",
      "telegram": "",
      "confidence": 0.0
    },
    "producers": [
      {
        "name": "Не определен",
        "email": "",
        "phone": "",
        "telegram": "",
        "confidence": 0.0
      }
    ],
    "production_company": {
      "name": "Не определен",
      "email": "",
      "phone": "",
      "website": "",
      "confidence": 0.0
    }
  }
}
```

### 3.3 Обучающий датасет (JSONL формат для OpenAI Fine-tuning)
```json
{
  "messages": [
    {
      "role": "system",
      "content": "Ты агент в большом агентстве артистов..."
    },
    {
      "role": "user",
      "content": "{\"request\": {...}, \"artists\": [...]}"
    },
    {
      "role": "assistant",
      "content": "{\"project_analysis\": {...}}"
    }
  ]
}
```

### 3.4 Промпт для LLM (OpenAI ChatGPT 4o)
```json
{
  "model": "gpt-4o",
  "system_prompt": "Ты агент в большом агентстве артистов. Твоя задача - анализировать запросы от кастинг-директоров и создавать структурированные проекты с ролями, подбирая подходящих артистов из базы данных.\n\nТы должен:\n1. Определить тип проекта (фильм, сериал, реклама, клип и т.д.)\n2. Извлечь требования к ролям из текста запроса\n3. Подобрать подходящих артистов из предоставленного списка\n4. Создать структурированное описание проекта с ролями\n5. Извлечь контактную информацию из текста запроса:\n   - Кастинг-директор (имя, телефон, email, telegram)\n   - Режиссер (имя, телефон, email, telegram)\n   - Продюсеры (имя, телефон, email, telegram)\n   - Кинокомпания (название, телефон, email, сайт)\n6. Если информация не найдена в тексте, используй данные автора запроса\n\nВАЖНО:\n- Используй ТОЛЬКО ID артистов из предоставленного списка\n- Отвечай ТОЛЬКО в формате JSON согласно предоставленной схеме\n- Все suggested_artists должны существовать в отправленном списке\n- Извлекай контакты из текста запроса, если они упомянуты\n- Указывай confidence (0.0-1.0) для извлеченной информации\n- Если не можешь определить поле - пиши 'Не определен'\n- При некорректной структуре JSON система автоматически повторит запрос",
  "user_prompt_template": "Проанализируй следующий запрос и создай проект с ролями:\n\nЗапрос: {request_text}\nАвтор: {author_name}\n\nДоступные артисты: {artists_json}\n\nВерни результат в формате JSON согласно схеме project_analysis.\nИспользуй ТОЛЬКО ID артистов из предоставленного списка.\nИзвлеки контактную информацию из текста запроса, если она упомянута.",
  "temperature": 0.3,
  "max_tokens": 2000
}
```

## 4. Архитектурный подход

### 4.1 Принцип единого интерфейса
- Один интерфейс для создания проектов (как из LLM анализа, так и вручную)
- Предзаполнение формы на основе анализа LLM
- Возможность ручного редактирования всех полей

### 4.2 Способы создания проекта
1. **Автоматический**: Запрос → LLM анализ → Предзаполненная форма → Корректировка → Сохранение
2. **Ручной**: Пустая форма → Заполнение → Сохранение

### 4.3 Система самообучения
- Сбор исправленных данных агентами (только финальные сохраненные проекты)
- Формирование обучающего датасета через ручной экспорт
- Создание JSONL файлов по 50 записей в каждом
- Админ запускает экспорт через кнопку в админ-панели или management команду
- Дообучение модели OpenAI происходит в ручном режиме (опционально)

## 5. Этапы реализации

### Этап 1: Базовая инфраструктура проектов (1-2 недели)
- Обновление моделей данных
- Создание API endpoints
- Базовая форма создания проектов
- Система ролей в проекте

### Этап 2: Интеграция с LLM (1-2 недели)
- Создание эмулятора LLM
- API для анализа запросов
- Интеграция с формой создания проекта
- Валидация и обработка ошибок

### Этап 3: Расширенный функционал (1-2 недели)
- Система поиска совпадений
- Медиа-компоненты
- Оптимизация UX
- Конфигурация и настройки

### Этап 4: Система самообучения (1-2 недели)
- Сбор обучающих данных
- Интеграция с OpenAI Fine-tuning
- Мониторинг и аналитика

### Этап 5: Тестирование и оптимизация (1 неделя)
- Комплексное тестирование
- Оптимизация производительности
- Документация и развертывание

## 6. Ключевые преимущества

### 6.1 Для агентов
- Автоматизация рутинных задач
- Быстрое создание проектов
- Умные предложения совпадений
- Единый интерфейс для всех операций

### 6.2 Для агентства
- Повышение эффективности работы
- Улучшение качества подбора артистов
- Система самообучения
- Конкурентное преимущество

### 6.3 Технические преимущества
- Модульная архитектура
- Легкое тестирование
- Возможность поэтапного внедрения
- Гибкая конфигурация

## 7. Основные риски и митигация

### 7.1 Технические риски
- **LLM может вернуть некорректную структуру JSON** → Система автоматических повторных попыток + строгая валидация
- **LLM может неверно интерпретировать данные** → Агент проверяет и корректирует все поля перед сохранением
- **Производительность при большом количестве артистов** → Предварительная фильтрация + оптимизация
- **Ошибки валидации JSON** → Система повторных попыток + логирование

### 7.2 Бизнес-риски
- **Зависимость от внешнего LLM** → Эмулятор для тестирования + кэширование
- **Качество анализа** → Ручная корректировка агентом + система самообучения через экспорт датасетов
- **Безопасность данных** → Передача данных как есть для лучшего контекста
- **Производительность системы** → Одновременная работа 1-10 агентов, оптимизация запросов

## 8. Заключение

Концепция интеграции LLM для автоматического анализа запросов представляет собой комплексное решение, которое значительно повысит эффективность работы агентства. 

### Ключевые особенности:
- **Автоматизация**: LLM анализирует запросы и предзаполняет формы проектов
- **Умные совпадения**: Система поиска существующих персон, компаний и проектов
- **Самообучение**: Сбор данных от агентов для улучшения качества анализа
- **Гибкость**: Возможность как автоматического, так и ручного создания проектов

### Готовность к реализации: 100%
Все технические решения приняты, архитектура определена, план поэтапного внедрения готов. Можно приступать к реализации.

---

**Примечание**: Детальный план по дням находится в файле `plan_20_days.md`
